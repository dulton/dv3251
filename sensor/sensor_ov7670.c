/******************** (C) COPYRIGHT 2013 BUILDWIN ************************
* File Name          : sensor_ov7670.c
* Author             : pengtao_zhang
* Version            : V0829a
* Date               : 08/29/2013
* Description        : This file provides all the sensor ov7670 firmware functions.
***************************************************************************/
//===================================================================
//                                                     	            |
//                       INCLUDE FILES                              |
//                                                                  |
//===================================================================
#include "../header/include.h"

#if(SEN_USE == SEN_OV7670)
//===================================================================
//                                                     	            |
//                      GLOBAL VARIABLE                             |
//                                                                  |
//===================================================================


u8 OV7670InitTable[][2] =
{
0x12, 0x80,
0x00, 0x00,
0x01, 0xDE,
0x02, 0x50,
0x03, 0x0F,
0x04, 0x01,
0x05, 0x7F,
0x06, 0xFE,
0x07, 0x00,
0x08, 0x7F,
0x09, 0x01,
0x0A, 0x76,
0x0B, 0x73,
0x0C, 0x00,
0x0D, 0x40,
0x0E, 0x61,
0x0F, 0x4B,//0x4F,
//0x0F, 0x5F,
0x10, 0x00,
0x11, 0x80,//0x40,
0x12, 0x00,
0x13, 0xE7,
0x14, 0x28,
0x15, 0x02,
0x16, 0x02,

0x17, 0x14,	//0x15, //0x14,	//?MPW?0x15,????????0x14,???????????
0x18, 0x03, //0x02,
0x19, 0x02,
0x1A, 0x7C,
0x1B, 0x01,

0x1C, 0x7F,
0x1D, 0xA2,
0x1E, 0x37,
0x1F, 0x00,
0x20, 0x07,//0x04,
0x21, 0x02,
0x22, 0x91,
0x23, 0x00,
0x24, 0x85,//0x50,
0x25, 0x33,
0x26, 0xe3,//0xD2,
0x27, 0x80,//0x8F,
0x28, 0x80,//0x02,
0x29, 0x07,
0x2A, 0x00,//00
0x2B, 0xb0,//0x00
0x2C, 0x82,
0x2D, 0x20,//0x00
0x2E, 0x00,//0x08
0x2F, 0x30,
0x30, 0x08,
0x31, 0x30,
0x32, 0xB6,//0x80,
0x33, 0x0B,
0x34, 0x11,
0x35, 0x0B,
0x34, 0x11,
0x35, 0x0B,
0x36, 0x00,
0x37, 0x1D,
0x38, 0x71,
0x39, 0x2A,
0x3A, 0x04,//0x0c
0x3B, 0x2A,//0xC8
0x3C, 0x78,
0x3D, 0x81,//0x82
0x3E, 0x00,
0x3F, 0x02,
0x40, 0xC0,
0x41, 0x18,
0x42, 0x00,
0x43, 0x0A,
0x44, 0xF0,
0x45, 0x34,
0x46, 0x58,
0x47, 0x28,
0x48, 0x3A,
0x49, 0x00,
0x4A, 0x00,
0x4B, 0x09,
0x4C, 0x04,//0x03,
0x4D, 0x40,
0x4E, 0x20,

0x4F, 0x81,//0x78,
0x50, 0x80,//0x76,
0x51, 0x00,//0x02,
0x52, 0x22,//0x20,
0x53, 0x5e,//0x6B,
0x54, 0x80,//0x8B,

//0x4f, 0x8C,
//0x50, 0x8E,
//0x51, 0x02,
//0x52, 0x26,
//0x53, 0x80,
//0x54, 0xA7,



0x55, 0x93,
0x56, 0x59,
0x57, 0x82,
0x58, 0x9E,
0x59, 0x88,
0x5A, 0x88,
0x5B, 0x44,
0x5C, 0x67,
0x5D, 0x49,
0x5E, 0x1F,
0x5F, 0xF0,
0x60, 0xF0,
0x61, 0xF0,
0x62, 0x30,
0x63, 0x30,
0x64, 0x08,
0x65, 0x00,
0x66, 0x05,
0x67, 0x80,
0x68, 0x80,
0x69, 0x00,
0x6A, 0x44,
0x6B, 0x0A,
0x6C, 0x0A,
0x6D, 0x55,
0x6E, 0x11,
0x6F, 0x9E,
0x70, 0x3A,
0x71, 0x35,
0x72, 0x11,
0x73, 0xF0,
0x74, 0x10,
0x75, 0x44,
0x76, 0xE1,
0x77, 0x01,
0x78, 0x00,
0x79, 0x00,

//0x7A, 0x1C,
//0x7B, 0x00,
//0x7C, 0x10,
//0x7D, 0x23,
//0x7E, 0x49,
//0x7F, 0x59,
//0x80, 0x6A,
//0x81, 0x76,
//0x82, 0x83,
//0x83, 0x8D,
//0x84, 0x95,
//0x85, 0xA6,
//0x86, 0xB3,
//0x87, 0xCA,
//0x88, 0xDB,
//0x89, 0xEB,


0x7A, 0x20,
0x7B, 0x1C,
0x7C, 0x28,
0x7D, 0x3C,
0x7E, 0x5A,
0x7F, 0x68,
0x80, 0x76,
0x81, 0x80,
0x82, 0x88,
0x83, 0x8F,
0x84, 0x96,
0x85, 0xA3,
0x86, 0xAF,
0x87, 0xC4,
0x88, 0xD7,
0x89, 0xE8,

0x8A, 0x00,
0x8B, 0x00,
0x8C, 0x00,
0x8D, 0x4F,
0x8E, 0x00,
0x8F, 0x00,
0x90, 0x00,
0x91, 0x00,
0x92, 0x00, //0x00
0x93, 0x00, //0x00
0x94, 0x07,
0x95, 0x06,
0x96, 0x00,
0x97, 0x30,
0x98, 0x20,
0x99, 0x20,
0x9A, 0x84,
0x9B, 0x29,
0x9C, 0x03,
0x9D, 0x99,
0x9E, 0x7F,
0x9F, 0xA0,//0x78,
0xA0, 0x90,//0x68,
0xA1, 0x0B,//0x03,
0xA2, 0x02,
0xA3, 0x05,//0x02,
0xA4, 0x89,//0x8a,
0xA5, 0x02,
0xA6, 0xD8,//0xd2,
0xA7, 0xD8,//0xd2,
0xA8, 0xF0,
0xA9, 0x90,//0x80,
0xAA, 0x14,
0xAB, 0x03,
0xAC, 0x00,
0xAD, 0x80,
0xAE, 0x80,
0xAF, 0x80,
0xB0, 0x84,
0xB1, 0x0C,
0xB2, 0x0E,
0xB3, 0x82,
0xB4, 0x00,
0xB5, 0x04,
0xB6, 0x00,
0xB7, 0x66,
0xB8, 0x0A,
0xB9, 0x06,
0xBA, 0x00,
0xBB, 0x00,
0xBC, 0x00,
0xBD, 0x00,
0xBE, 0x47,
0xBF, 0x47,
0xC0, 0x41,
0xC1, 0x41,
0xC2, 0x00,
0xC3, 0x00,
0xc4, 0x00,
0xC5, 0x00,
0xC6, 0x50,
0xC7, 0x50,
0xC8, 0x06,
0xC9, 0x6E,

0xC9, 0x6E,
0x78, 0x00,
0x79, 0x01,
0xC8, 0xF0,
0x79, 0x0F,
0xC8, 0x20,
0x79, 0x10,
0xC8, 0x7E,
0x79, 0x0B,
0xC8, 0x01,
0x79, 0x0C,
0xC8, 0x07,
0x79, 0x0D,
0xC8, 0x20,
0x79, 0x09,
0xC8, 0x80,
0x79, 0x02,
0xC8, 0xC0,
0x79, 0x03,
0xC8, 0x40,
0x79, 0x05,
0xC8, 0x30,
0x79, 0x00,
0xBE, 0x08,
0xBF, 0x08,
0xC0, 0x07,
0xC1, 0x07,
0xC7, 0x06,
0xC8, 0x06,          
};

/*******************************************************************************
* Function Name  : sensor_Init
* Description    : initialize the sensor
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
u8 sensor_Init(void)
{
     u32 i;
     u8 j;
     u8 u8Buf[2];  
	 u8 SensorId;
     
	 #if(SYS_CLK == 120000000)
		sensor_ClockInit(24000000);
	 #elif(SYS_CLK == 48000000)
		sensor_ClockInit(12000000);
	 #endif
     u8SensorwriteID = OV7670_I2C_WRITE_ADDR;
     u8SensorreadID = OV7670_I2C_READ_ADDR;
     u8Addrbytnum = 1;
     u8Databytnum = 1;

	//=======close sensor power ========
	#if (I2C_MAP == I2C_MAP_SW2)			//select software simulate I2C signal
	bI2CBusy_Flag=1;					//set dc check unuse
	bSFBusy_Flag=1;						//set tf card check unuse
	REG32(PMAP_CFG0)  &= ~(1<<14);		//SPI0_MAP0 not mapping to io
	REG32(PMAP_CFG0)  &= ~(1<<7);		// uart not map to io 
	I2C_SCL_SDA_OUT();
	I2C_SCL_LOW();
	I2C_SDA_LOW();
	#endif

	REG32(SYS_CON) = 0x932B;			//SPEC request value
	REG32(LDO_ACON) &= ~(0xf << 4);		//close senosr ldo power

	#if	(USER_CONFIG==CONFIG_AX3251_K6000)		
	Delay_MS(250);		//rc reset need delay, IO reset not do it
	#endif

	#if (I2C_MAP == I2C_MAP_SW2)	//select software simulate I2C signal
	bI2CBusy_Flag=0;
	bSFBusy_Flag=0;
	#endif
	//======end close sensor power=======

	//====sensor ldo open======
	REG32(LDO_ACON) |= (2<<4);   //sensor 3bit 111:3.3v,110:3.2v .... 000:2.6v
	REG32(LDO_ACON) |= (1<<7);   //sensor ldo enable
	Delay_MS(50);
	//===end sensor ldo open====

     i2c_Init(OV7670_I2C_BAUD, OV7670_I2C_WRITE_ADDR,OV7670_I2C_READ_ADDR);
     CLRB(REG32(PCON0), 23);							//csi Clock Enable Bit
   
     //SENSOR_PIN_CONF();
     //SENSOR_POWERDN();
     SENSOR_NRESET();
     Delay_MS(10);
     SENSOR_RESET();
     Delay_MS(10);
     SENSOR_NRESET();
     //SENSOR_NORMAL();
     Delay_MS(10);

	i2c_SendStop();
     SensorId = u8sensor_ReadID();
     for(i=0; i<sizeof(OV7670InitTable)/2; i++)
     {
         for(j=0; j<(u8Addrbytnum+u8Databytnum); j++) 
         {
             u8Buf[j] = OV7670InitTable[i][j];    
         }   
         Sensor_WriteRegister(u8Buf,u8Addrbytnum,u8Databytnum);
         Delay_MS(1);
     } 
	sensor_I2C_port_release();
	deg_Printf("SensorId=%x\n",SensorId);
       return 0;
}

/*******************************************************************************
* Function Name  : u8sensor_ReadID
* Description    : read sensor chip ID
* Input          : None
* Output         : None
* Return         : sensor chip ID
*******************************************************************************/
u8 u8sensor_ReadID(void)
{
    u8 u8OV7670Id;
    u8 u8Buf[2];  
    
    u8Buf[0] = OV7670_CHIP_ID_ADDR;
    u8OV7670Id = (u8)Sensor_ReadRegister(u8Buf,u8Addrbytnum,u8Databytnum); 
    //deg_Printf("u8OV7670Id=%x\n",u8OV7670Id);
    return  u8OV7670Id;                         
}

//=====flag: 0 is rotate 0',  1 is rotate 180'  flip====
void sensor_rotate(u8 flag)
{
	u8 rot_buf[2];
	 i2c_Init(OV7670_I2C_BAUD, OV7670_I2C_WRITE_ADDR,OV7670_I2C_READ_ADDR);
	 i2c_SendStop();
	//deg_Printf("rotate=%x",flag);
	if(0 == flag)
	{
		rot_buf[0] = 0x1e;
		rot_buf[1] = 0x07;
		 Sensor_WriteRegister(rot_buf,1,1);
	}
	else if(1 == flag)
	{
		rot_buf[0] = 0x1e;
		rot_buf[1] = 0x37;
		 Sensor_WriteRegister(rot_buf,1,1);
	}
	sensor_I2C_port_release();

}


#endif
