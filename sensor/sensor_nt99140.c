/******************** (C) COPYRIGHT 2013 BUILDWIN ************************
* File Name          : sensor_nt99140.c
* Author             : pengtao_zhang
* Version            : V0826a
* Date               : 08/26/2013
* Description        : This file provides all the sensor nt99140 firmware functions.
***************************************************************************/
//===================================================================
//                                                     	            |
//                       INCLUDE FILES                              |
//                                                                  |
//===================================================================
#include "../header/include.h"

#if(SEN_USE == SEN_NT99140)
//===================================================================
//                                                     	            |
//                      GLOBAL VARIABLE                             |
//                                                                  |
//===================================================================
#if 0
u8 NT99140InitTable_640_480[][3] =
{
{0x30,0x21, 0x01},
{0x30,0x21, 0x06},

{0x32,0xF0, 0x01},    // Output_Format_Sel 0:YCbCr
{0x30,0x28, 0x07},
{0x30,0x29, 0x00},
{0x30,0x2a, 0x00},

//{0x33,0x36, 0x14},    //DP_ThrW=Defect pixel threshold for white
{0x32,0x10, 0x0F},    //[LSC_Calibration_90%]
{0x32,0x11, 0x0F},
{0x32,0x12, 0x10},
{0x32,0x13, 0x0F},
{0x32,0x14, 0x0E},
{0x32,0x15, 0x0E},
{0x32,0x16, 0x0E},
{0x32,0x17, 0x0E},
{0x32,0x18, 0x0E},
{0x32,0x19, 0x0E},
{0x32,0x1A, 0x0E},
{0x32,0x1B, 0x0E},
{0x32,0x1C, 0x0E},
{0x32,0x1D, 0x0E},
{0x32,0x1E, 0x0E},
{0x32,0x1F, 0x0E},
{0x32,0x20, 0x01},    //LSC_CenterX_R_H
{0x32,0x21, 0x36},    //LSC_CenterX_R_L
{0x32,0x22, 0x01},    //LSC_CenterX_Gr_H
{0x32,0x23, 0x32},    //LSC_CenterX_Gr_L
{0x32,0x24, 0x01},    //LSC_CenterX_Gb_H
{0x32,0x25, 0x32},    //LSC_CenterX_Gb_L
{0x32,0x26, 0x01},    //LSC_CenterX_B_H
{0x32,0x27, 0x2F},    //LSC_CenterX_B_L
{0x32,0x28, 0x00},
{0x32,0x29, 0xAF},
{0x32,0x2A, 0x00},
{0x32,0x2B, 0xAF},
{0x32,0x2C, 0x00},
{0x32,0x2D, 0xAF},
{0x32,0x2E, 0x00},
{0x32,0x2F, 0xAF},
{0x32,0x30, 0x1D},	  //Gain Upperbound
{0x32,0x31, 0x00},
{0x32,0x32, 0x04},	  // exposure line upperbound
{0x32,0x33, 0x30},
{0x32,0x34, 0x43},
		
{0x32,0x70, 0x00},   //[Gamma3]
{0x32,0x71, 0x0B},
{0x32,0x72, 0x16},
{0x32,0x73, 0x2B},
{0x32,0x74, 0x3F},
{0x32,0x75, 0x51},
{0x32,0x76, 0x72},
{0x32,0x77, 0x8F},
{0x32,0x78, 0xA7},
{0x32,0x79, 0xBC},
{0x32,0x7A, 0xDC},
{0x32,0x7B, 0xF0},
{0x32,0x7C, 0xFA},
{0x32,0x7D, 0xFE},
{0x32,0x7E, 0xFF},

{0x33,0x02, 0x00},    //[Color_calibration]
{0x33,0x03, 0x3C},
{0x33,0x04, 0x00},
{0x33,0x05, 0xA6},
{0x33,0x06, 0x00},
{0x33,0x07, 0x1C},
{0x33,0x08, 0x07},
{0x33,0x09, 0xE1},
{0x33,0x0A, 0x06},
{0x33,0x0B, 0x9B},
{0x33,0x0C, 0x01},
{0x33,0x0D, 0x84},
{0x33,0x0E, 0x00},
{0x33,0x0F, 0xEF},
{0x33,0x10, 0x07},
{0x33,0x11, 0x69},
{0x33,0x12, 0x07},
{0x33,0x13, 0xA9},

{0x33,0x00, 0x70},    // denoise
{0x33,0x01, 0x40},    // enhance
{0x30,0x24, 0x08}, //00    // clk edge phase
{0x30,0x40, 0x04},    // Calibration Control
{0x30,0x41, 0x02},    // Auto Calibration
{0x30,0x42, 0xFF},    // ABLC_Thr_Top
{0x30,0x43, 0x14},    // ABLC_Thr_Bottom
{0x30,0x52, 0xd0},    // ABLC_GAIN
//{0x30,0x57, 0x80},    // DeRowDefect_ThrH
//{0x30,0x58, 0x00},    // DeRowDefect_ThrL
//{0x30,0x59, 0x2F},    // DeRowDefect_Control
//{0x30,0x5f, 0x44},
{0x32,0xb0, 0x00},  // LA
{0x32,0xb1, 0x90},

{0x32,0xBB, 0x0b},  // AE
{0x32,0xbd, 0x10},
{0x32,0xbe, 0x05},
{0x32,0xbf, 0x4a},
{0x32,0xc0, 0x40},
{0x32,0xC3, 0x02},   //08    // AGC_Min_Limit
{0x32,0xc5, 0x1f},    // AGC_Max_Limit

//{0x32,0xcd, 0x01},    //FGC adjustment speed
//{0x32,0xd3, 0x00},
{0x32,0xf6, 0x0c},  	// Special_Effect_1
{0x33,0x24, 0x00},
{0x31,0x18, 0xF2},
{0x31,0x19, 0xF2},
{0x31,0x1A, 0x13},
{0x31,0x06, 0x01},
{0x31,0x08, 0x55},
{0x31,0x05, 0x41},     // 40uA
{0x31,0x12, 0x21},
{0x31,0x13, 0x55},
{0x31,0x14, 0x05},
{0x33,0x43, 0xA0},    //[Auto_Ctrl]
{0x33,0x3b, 0x20},
{0x33,0x3c, 0x28},
{0x33,0x44, 0x28},
{0x33,0x45, 0x30},
{0x33,0x46, 0x30},
{0x33,0x48, 0x00},
{0x33,0x49, 0x40},
{0x33,0x4a, 0x30},
{0x33,0x4b, 0x00},
{0x33,0x4d, 0x15},
{0x33,0x00, 0x90},//0x20
{0x33,0x01, 0xdc},


//{0x33, 0x31, 0x04},//0x05
//{0x33, 0x32, 0x40},
{0x32, 0x00, 0x3e},// control
{0x32, 0x01, 0x3f},// module enable

{0x32, 0xE0, 0x02},//sclaler
{0x32, 0xE1, 0x80},
{0x32, 0xE2, 0x01},
{0x32, 0xE3, 0xE0},
{0x32, 0xE4, 0x00},
{0x32, 0xE5, 0x80},
{0x32, 0xE6, 0x00},
{0x32, 0xE7, 0x80},

{0x30, 0x28, 0x07},
{0x30, 0x29, 0x00},
{0x30, 0x2a, 0x08},//0x04 pt


{0x30, 0x22, 0x24},
{0x30, 0x23, 0x24},

{0x30, 0x02, 0x01},  // start end
{0x30, 0x03, 0xE4},
{0x30, 0x04, 0x00},
{0x30, 0x05, 0x34},
{0x30, 0x06, 0x04},
{0x30, 0x07, 0x63},
{0x30, 0x08, 0x02},
{0x30, 0x09, 0x13},
{                }
{0x30, 0x0A, 0x06},  // hblank+imagewidth
{0x30, 0x0B, 0x20},
{0x30, 0x0C, 0x02},  // vblank+imagewidth
{0x30, 0x0D, 0x00},
//{0x30, 0x0A, 0x05},  // hblank+imagewidth
//{0x30, 0x0B, 0x40},
//{0x30, 0x0C, 0x03},  // vblank+imagewidth
//{0x30, 0x0D, 0x20},

{0x30, 0x0E, 0x02},  // output size
{0x30, 0x0F, 0x80},
{0x30, 0x10, 0x01},
{0x30, 0x11, 0xe0},

{0x32, 0xBB, 0x1B},  // AE
{0x32, 0xBC, 0x40},
{0x32, 0xC1, 0x2E},
{0x32, 0xC2, 0xA6},
{0x32, 0xC8, 0xFA},
{0x32, 0xC9, 0xD0},
{0x32, 0xC4, 0x00},		

{0x32, 0x01, 0x3F},  //moudle enable
{0x30, 0x21, 0x06},  //lsc
{0x32, 0xc5, 0x2f},  // agc
{0x30, 0x60, 0x01},
                        
};
#endif

u8 NT99140InitTable_1280_720[][3] =
{
0x32,0xF0, 0x01,    // Output_Format_Sel 0:YCbCr
	0x30,0x28, 0x07, 
    0x30,0x29, 0x00, 
	0x30,0x2a, 0x00, 
0x33,0x36, 0x14,    //DP_ThrW=Defect pixel threshold for white
0x32,0x10, 0x0F,    //[LSC_Calibration_90%]
0x32,0x11, 0x0F,
0x32,0x12, 0x10,
0x32,0x13, 0x0F,
0x32,0x14, 0x0E,
0x32,0x15, 0x0E,
0x32,0x16, 0x0E,
0x32,0x17, 0x0E,
0x32,0x18, 0x0E,
0x32,0x19, 0x0E,
0x32,0x1A, 0x0E,
0x32,0x1B, 0x0E,
0x32,0x1C, 0x0E,
0x32,0x1D, 0x0E,
0x32,0x1E, 0x0E,
0x32,0x1F, 0x0E,
0x32,0x20, 0x01,    //LSC_CenterX_R_H 
0x32,0x21, 0x36,    //LSC_CenterX_R_L 
0x32,0x22, 0x01,    //LSC_CenterX_Gr_H 
0x32,0x23, 0x32,    //LSC_CenterX_Gr_L 
0x32,0x24, 0x01,    //LSC_CenterX_Gb_H 
0x32,0x25, 0x32,    //LSC_CenterX_Gb_L 
0x32,0x26, 0x01,    //LSC_CenterX_B_H 
0x32,0x27, 0x2F,    //LSC_CenterX_B_L
0x32,0x28, 0x00,
0x32,0x29, 0xAF,
0x32,0x2A, 0x00,
0x32,0x2B, 0xAF,
0x32,0x2C, 0x00,
0x32,0x2D, 0xAF,
0x32,0x2E, 0x00,
0x32,0x2F, 0xAF,
0x32,0x30, 0x1D,	  //Gain Upperbound
0x32,0x31, 0x00,
0x32,0x32, 0x04,	  // exposure line upperbound
0x32,0x33, 0x30,	
0x32,0x34, 0x43,
0x32,0x70, 0x00,   //[Gamma3]	
0x32,0x71, 0x0B,
0x32,0x72, 0x16,
0x32,0x73, 0x2B,
0x32,0x74, 0x3F,
0x32,0x75, 0x51,
0x32,0x76, 0x72,
0x32,0x77, 0x8F,
0x32,0x78, 0xA7,
0x32,0x79, 0xBC,
0x32,0x7A, 0xDC,
0x32,0x7B, 0xF0,
0x32,0x7C, 0xFA,
0x32,0x7D, 0xFE,
0x32,0x7E, 0xFF,
0x33,0x02, 0x00,    //[Color_calibration]
0x33,0x03, 0x3C,
0x33,0x04, 0x00,
0x33,0x05, 0xA6,
0x33,0x06, 0x00,
0x33,0x07, 0x1C,
0x33,0x08, 0x07,
0x33,0x09, 0xE1,
0x33,0x0A, 0x06,
0x33,0x0B, 0x9B,
0x33,0x0C, 0x01,
0x33,0x0D, 0x84,
0x33,0x0E, 0x00,
0x33,0x0F, 0xEF,
0x33,0x10, 0x07,
0x33,0x11, 0x69,
0x33,0x12, 0x07,
0x33,0x13, 0xA9,
0x33,0x00, 0x70,     
0x33,0x01, 0x40,    
//#if  NT99140_MJPG_40M
//0x30,0x24, 0x08,     // clk edge phase
//#else
0x30,0x24, 0x00,     // clk edge phase
//#endif
0x30,0x40, 0x04,    // Calibration Control
0x30,0x41, 0x02,    // Auto Calibration
0x30,0x42, 0xFF,    // ABLC_Thr_Top
0x30,0x43, 0x14,    // ABLC_Thr_Bottom
0x30,0x52, 0xd0,
0x30,0x57, 0x80,    // DeRowDefect_ThrH
0x30,0x58, 0x00,    // DeRowDefect_ThrL
0x30,0x59, 0x2F,    // DeRowDefect_Control
0x30,0x5f, 0x44,	
0x30,0x68, 0x02,	 
0x30,0x69, 0x02,	 
0x30,0x6a, 0x02,	 
0x32,0xb0, 0x00,
0x32,0xb1, 0x90,
0x32,0xBB, 0x0b,
0x32,0xbd, 0x10,
0x32,0xbe, 0x05,
0x32,0xbf, 0x4a,
0x32,0xc0, 0x40,
0x32,0xC3, 0x02,   //08    // AGC_Min_Limit
0x32,0xc5, 0x1f,    // AGC_Max_Limit
0x32,0xcd, 0x01,    //FGC adjustment speed
0x32,0xd3, 0x00,
0x32,0xf6, 0x0c,  	// Special_Effect_1
0x33,0x24, 0x00,
0x31,0x18, 0xF2,
0x31,0x19, 0xF2,
0x31,0x1A, 0x13,
0x31,0x06, 0x01,
0x31,0x08, 0x55,
0x31,0x05, 0x41,     // 40uA
0x31,0x12, 0x21,
0x31,0x13, 0x55,
0x31,0x14, 0x05,
0x33,0x43, 0xA0,    //[Auto_Ctrl]
0x33,0x3b, 0x20,
0x33,0x3c, 0x28,
0x33,0x44, 0x28,
0x33,0x45, 0x30,
0x33,0x46, 0x30,
0x33,0x48, 0x00,
0x33,0x49, 0x40,
0x33,0x4a, 0x30,
0x33,0x4b, 0x00,
0x33,0x4d, 0x15,
0x32,0xf0, 0x01, 
//0x34,0x00, 0x08, 
//0x34,0x00, 0x00, 
//0x34,0x01, 0x4e, 
//0x34,0x02, 0x1c, 
//0x34,0x03, 0x20, 
//0x34,0x04, 0x00, 
//0x34,0x05, 0x50, 
//0x34,0x0b, 0x05, 
//0x34,0x0c, 0x00, 
//0x34,0x0d, 0x02, 
//0x34,0x0e, 0xd0, 
//0x34,0x10, 0x00, 
//0x30,0x28, 0x27, 
//0x30,0x29, 0x20, 
//0x30,0x2a, 0x04, 
//#if  NT99140_MJPG_40M
//	0x30,0x28, 0x0f, 
//	0x30,0x29, 0x00,
//	0x30,0x2a, 0x04, 
//#else
	0x30,0x28, 0x07, 
    0x30,0x29, 0x00, 
	0x30,0x2a, 0x04,//04 pt
//#endif
0x30,0x22, 0x24, 
0x30,0x23, 0x24, 
0x30,0x02, 0x00, 
0x30,0x03, 0x04, //04
0x30,0x04, 0x00, 
0x30,0x05, 0x04, //04
0x30,0x06, 0x05, 
0x30,0x07, 0x03, //03
0x30,0x08, 0x02, 
0x30,0x09, 0xd3, 
0x30,0x0a, 0x07,//0x07//0x06,
0x30,0x0b, 0xa0,//0x00//0x7c,
0x30,0x0c, 0x03,//0x02//0x03,
0x30,0x0d, 0x23,//0xe3//0x23,
0x30,0x0e, 0x05, //0500
0x30,0x0f, 0x00, 
//0x30,0x0e, 0x02,
//0x30,0x0f, 0x80,
0x30,0x10, 0x02, //02d0
0x30,0x11, 0xd0, 
//0x30,0x10, 0x01,
//0x30,0x11, 0xe0,
0x32,0xb0, 0x00, 
0x32,0xb1, 0x00, 
0x32,0xb2, 0x01, 
0x32,0xb3, 0x7c, 
0x32,0xb4, 0x00, 
0x32,0xb5, 0x64, 
0x32,0xb6, 0x99, 
0x32,0xbb, 0x1b, 
0x32,0xbc, 0x40, 
0x32,0xc1, 0x23, 
0x32,0xc2, 0xec, 
0x32,0xc8, 0x78, 
0x32,0xc9, 0x64, 
0x32,0x00, 0x3e, 
0x32,0x01, 0x3f, 
0x30,0x21, 0x06, 
//0x34,0x00, 0x01, 
0x30,0x60, 0x01                                  
};


/*******************************************************************************
* Function Name  : sensor_Init
* Description    : initialize the sensor
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
u8 sensor_Init(void)
{
     u32 i;
     u8 j;
     u8 u8Buf[3];
	 u8 SensorId;
     
	 #if(SYS_CLK == 120000000)
		sensor_ClockInit(40000000);
	 #elif(SYS_CLK == 48000000)
		sensor_ClockInit(24000000);
	 #endif

     u8SensorwriteID = NT99140_I2C_WRITE_ADDR;
     u8SensorreadID = NT99140_I2C_READ_ADDR;
     u8Addrbytnum = 2;
     u8Databytnum = 1;

	//=======close sensor power ========
	#if (I2C_MAP == I2C_MAP_SW2)			//select software simulate I2C signal
	bI2CBusy_Flag=1;					//set dc check unuse
	bSFBusy_Flag=1;						//set tf card check unuse
	REG32(PMAP_CFG0)  &= ~(1<<14);		//SPI0_MAP0 not mapping to io
	REG32(PMAP_CFG0)  &= ~(1<<7);		// uart not map to io 
	I2C_SCL_SDA_OUT();
	I2C_SCL_LOW();
	I2C_SDA_LOW();
	#endif

	REG32(SYS_CON) = 0x932B;			//SPEC request value
	REG32(LDO_ACON) &= ~(0xf << 4);		//close senosr ldo power

	#if	(USER_CONFIG==CONFIG_AX3251_K6000)		
	Delay_MS(250);		//rc reset need delay, IO reset not do it
	#endif

	#if (I2C_MAP == I2C_MAP_SW2)	//select software simulate I2C signal
	bI2CBusy_Flag=0;
	bSFBusy_Flag=0;
	#endif
	//======end close sensor power=======

	//====sensor ldo open======
	REG32(LDO_ACON) |= (7<<4);   //sensor 3bit 111:3.3v,110:3.2v .... 000:2.6v
	REG32(LDO_ACON) |= (1<<7);   //sensor ldo enable
	Delay_MS(50);
	//===end sensor ldo open====

     i2c_Init(NT99140_I2C_BAUD, NT99140_I2C_WRITE_ADDR,NT99140_I2C_READ_ADDR);
     CLRB(REG32(PCON0), 23);							//csi Clock Enable Bit

     //SENSOR_PIN_CONF();
     //SENSOR_NORMAL();
    // SENSOR_POWERDN();
     SENSOR_NRESET();
     Delay_MS(10);
     SENSOR_RESET();
     Delay_MS(10);
     SENSOR_NRESET();
   //  SENSOR_NORMAL();
     Delay_MS(10);

	i2c_SendStop();
     SensorId = u8sensor_ReadID();
     for(i=0; i<sizeof(NT99140InitTable_1280_720)/3; i++)
     {
          for(j=0; j<(u8Addrbytnum+u8Databytnum); j++) 
         {
             u8Buf[j] = NT99140InitTable_1280_720[i][j];
         }   
         Sensor_WriteRegister(u8Buf,u8Addrbytnum,u8Databytnum);
         Delay_MS(1);
     }
	/*#if(JPEG_PICTURE_SIZE == JPEG_SIZE_2560_1440)
     u8Buf[0] = 0x30;
     u8Buf[1] = 0x2a;
     u8Buf[2] = 0x08;
     Sensor_WriteRegister(u8Buf,u8Addrbytnum,u8Databytnum);
	#endif*/
	sensor_I2C_port_release();
	deg_Printf("SensorId=%x\n",SensorId);
	return 0;
}

/*******************************************************************************
* Function Name  : u8sensor_ReadID
* Description    : read sensor chip ID
* Input          : None
* Output         : None
* Return         : sensor chip ID
*******************************************************************************/
u8 u8sensor_ReadID(void)
{
    u8 u8NT99140Id;  
    u8 u8Buf[3]; 
    
    u8Buf[0] = (NT99140_CHIP_ID_ADDR >> 8) & 0xff;
    u8Buf[1] = NT99140_CHIP_ID_ADDR & 0xff;
    u8NT99140Id = (u8)Sensor_ReadRegister(u8Buf,u8Addrbytnum,u8Databytnum);  
    //deg_Printf("u8NT99140Id=%x\n",u8NT99140Id);
    return  u8NT99140Id;               
}

//=====flag: 0 is rotate 0',  1 is rotate 180'  flip====
void sensor_rotate(u8 flag)
{

/*
	if(0 == flag)
	{
		u8 rot_buf[2];
		rot_buf[0] = 0x04;
		rot_buf[1] = 0xc8;
		 Sensor_WriteRegister(rot_buf,1,1);
		rot_buf[0] = 0x03;
		rot_buf[1] = 0x01;
		 Sensor_WriteRegister(rot_buf,1,1);
		rot_buf[0] = 0x19;
		rot_buf[1] = 0x01;
		 Sensor_WriteRegister(rot_buf,1,1);
	}
	else if(1 == flag)
	{
		u8 rot_buf[2];
		rot_buf[0] = 0x04;
		rot_buf[1] = 0x88;
		 Sensor_WriteRegister(rot_buf,1,1);
		rot_buf[0] = 0x03;
		rot_buf[1] = 0x02;
		 Sensor_WriteRegister(rot_buf,1,1);
		rot_buf[0] = 0x19;
		rot_buf[1] = 0x02;
		 Sensor_WriteRegister(rot_buf,1,1);
	}
*/
	
}


#endif
