/******************** (C) COPYRIGHT 2013 BUILDWIN ************************
* File Name          : sensor_gc0308.c
* Author             : pengtao_zhang
* Version            : V0726a
* Date               : 07/26/2013
* Description        : This file provides all the sensor gc0308 firmware functions.
***************************************************************************/
//===================================================================
//                                                     	            |
//                       INCLUDE FILES                              |
//                                                                  |
//===================================================================
#include "../header/include.h"

#if(SEN_USE == SEN_GC0308)
//===================================================================
//                                                     	            |
//                      GLOBAL VARIABLE                             |
//                                                                  |
//===================================================================
u8 GC0308InitTable[][2] =
{
	    {0xfe,0x80},//soft rest and select page0------------------------------------------------------
	    {0xfe,0x00},
	    {0xd2,0x10},
	    {0x22,0x55},
	    {0x5a,0x56},//0x56 R
	    {0x5b,0x40},//0x40 G
	    {0x5c,0x4a},//0x4a B
	    {0x22,0x57},
	    {0x01,0xde}, 
	    {0x02,0x24},  
	    {0x0f,0x00}, //{0x0f,0x00},
	    {0x03,0x01},
	    {0x04,0x2c},
	    {0xe2,0x00},
	    {0xe3,0x83},
	    {0xe4,0x02},//exp level
	    {0xe5,0x8f},
	    {0xe6,0x02},
	    {0xe7,0x8f},
	    {0xe8,0x02},
	    {0xe9,0x8f},
	    {0xea,0x03},
	    {0xeb,0x95},
	    {0x05,0x00},//window size and position
	    {0x06,0x00},
	    {0x07,0x00},
	    {0x08,0x00},
	    {0x09,0x01},
	    {0x0a,0xe8},
	    {0x0b,0x02},
	    {0x0c,0x88},
	    {0x0d,0x02},
	    {0x0e,0x02},
	    {0x10,0x22},
	    {0x11,0xfd},
	    {0x12,0x2a},
	    {0x13,0x00},
	    {0x14,0x10},		//0',180'
	    {0x15,0x0a},
	    {0x16,0x05},
	    {0x17,0x01},
	    {0x18,0x44},
	    {0x19,0x44},
	    {0x1a,0x1e},
	    {0x1b,0x00},
	    {0x1c,0xc1},//current
	    {0x1d,0x08},
	    {0x1e,0x60},
	    {0x1f,0x3f},//0x16
	    {0x20,0xff},
	    {0x21,0xf8},
	    {0x22,0x57},
	    {0x24,0xa2},//0xa0 pt
	    {0x25,0x0f},
	    {0x26,0x03},
	    {0x2f,0x01},
	    {0x30,0xf7},//BLK
	    {0x31,0x50},
	    {0x32,0x00},
	    {0x39,0x04},
	    {0x3a,0x18},
	    {0x3b,0x20},
	    {0x3c,0x00},
	    {0x3d,0x00},
	    {0x3e,0x00},
	    {0x3f,0x00},
	    {0x50,0x10},//PREGAIN
	    {0x53,0x82},
	    {0x54,0x80},
	    {0x55,0x80},
	    {0x56,0x82},
	    {0x8b,0x40},//LSC
	    {0x8c,0x40},
	    {0x8d,0x40},
	    {0x8e,0x2e},
	    {0x8f,0x2e},
	    {0x90,0x2e},
	    {0x91,0x3c},
	    {0x92,0x50},
	    {0x5d,0x12},
	    {0x5e,0x1a},
	    {0x5f,0x24},
	    {0x60,0x07},//DNDD È¥Ôë
	    {0x61,0x15},
	    {0x62,0x08},
	    {0x64,0x03},
	    {0x66,0xe8},
	    {0x67,0x86},
	    {0x68,0xa2},
	    {0x69,0x18},//ASDE
	    {0x6a,0x0f},
	    {0x6b,0x00},
	    {0x6c,0x5f},
	    {0x6d,0x8f},
	    {0x6e,0x55},
	    {0x6f,0x38},
	    {0x70,0x15},
	    {0x71,0x33},
	    {0x72,0xdc},//0xdc INTPEE edge
	    {0x73,0x80},//0x80
	    {0x74,0x02},
	    {0x75,0x3f},
	    {0x76,0x02},
	    {0x77,0x36},
	    {0x78,0x88},
	    {0x79,0x81},
	    {0x7a,0x81},
	    {0x7b,0x22},
	    {0x7c,0xff},
	    {0x93,0x48},//CC
	    {0x94,0x00},
	    {0x95,0x05},
	    {0x96,0xe8},
	    {0x97,0x40},
	    {0x98,0xf0},
	    {0xb1,0x38},//YCP
	    {0xb2,0x38},
	    {0xbd,0x38},
	    {0xbe,0x36},
	    {0xd0,0xc9},//AEC
	    {0xd1,0x10},
	    {0xd3,0x80},//0x80
	    {0xd5,0xf2},
	    {0xd6,0x16},
	    {0xdb,0x92},
	    {0xdc,0xa5},
	    {0xdf,0x23},
	    {0xd9,0x00},
	    {0xda,0x00},
	    {0xe0,0x09},
	    {0xec,0x20},
	    {0xed,0x04},
	    {0xee,0xa0},
	    {0xef,0x40},
	    {0x80,0x03},
	    {0x80,0x03},
	    {0x9F,0x10},
	    {0xA0,0x20},
	    {0xA1,0x38},
	    {0xA2,0x4E},
	    {0xA3,0x63},
	    {0xA4,0x76},
	    {0xA5,0x87},
	    {0xA6,0xA2},
	    {0xA7,0xB8},
	    {0xA8,0xCA},
	    {0xA9,0xD8},
	    {0xAA,0xE3},
	    {0xAB,0xEB},
	    {0xAC,0xF0},
	    {0xAD,0xF8},
	    {0xAE,0xFD},
	    {0xAF,0xFF},
	    {0xc0,0x00},
	    {0xc1,0x10},
	    {0xc2,0x1C},
	    {0xc3,0x30},
	    {0xc4,0x43},
	    {0xc5,0x54},
	    {0xc6,0x65},
	    {0xc7,0x75},
	    {0xc8,0x93},
	    {0xc9,0xB0},
	    {0xca,0xCB},
	    {0xcb,0xE6},
	    {0xcc,0xFF},
	    {0xf0,0x02},//ABS
	    {0xf1,0x01},
	    {0xf2,0x01},
	    {0xf3,0x30},
	    {0xf9,0x9f},//measure window
	    {0xfa,0x78},
	    {0xfe,0x01},//select page1---------------------------------------------------------------
	    {0x00,0xf5},
	    {0x02,0x1a},
	    {0x0a,0xa0},
	    {0x0b,0x60},
	    {0x0c,0x08},
	    {0x0e,0x4c},
	    {0x0f,0x39},
	    {0x11,0x3f},
	    {0x12,0x72},
	    {0x13,0x13},
	    {0x14,0x42},
	    {0x15,0x43},
	    {0x16,0xc2},
	    {0x17,0xa8},
	    {0x18,0x18},
	    {0x19,0x40},
	    {0x1a,0xd0},
	    {0x1b,0xf5},
	    {0x70,0x40},
	    {0x71,0x58},
	    {0x72,0x30},
	    {0x73,0x48},
	    {0x74,0x20},
	    {0x75,0x60},
	    {0x77,0x20},
	    {0x78,0x32},
	    {0x30,0x03},
	    {0x31,0x40},
	    {0x32,0xe0},
	    {0x33,0xe0},
	    {0x34,0xe0},
	    {0x35,0xb0},
	    {0x36,0xc0},
	    {0x37,0xc0},
	    {0x38,0x04},
	    {0x39,0x09},
	    {0x3a,0x12},
	    {0x3b,0x1C},
	    {0x3c,0x28},
	    {0x3d,0x31},
	    {0x3e,0x44},
	    {0x3f,0x57},
	    {0x40,0x6C},
	    {0x41,0x81},
	    {0x42,0x94},
	    {0x43,0xA7},
	    {0x44,0xB8},
	    {0x45,0xD6},
	    {0x46,0xEE},
	    {0x47,0x0d},
	    {0xfe,0x00},
	    {0xd2,0x90},
	    {0xfe,0x00},
	    {0x10,0x26},
	    {0x11,0x0d},
	    {0x1a,0x2a},
	    {0x1c,0x49},
	    {0x1d,0x9a},
	    {0x1e,0x61},
	    {0x3a,0x20},
	    {0x50,0x14},
	    {0x53,0x80},
	    {0x56,0x80},
	    {0x8b,0x20},
	    {0x8c,0x20},
	    {0x8d,0x20},
	    {0x8e,0x14},
	    {0x8f,0x10},
	    {0x90,0x14},
	    {0x94,0x02},
	    {0x95,0x07},
	    {0x96,0xe0},
	    {0xb1,0x40},
	    {0xb2,0x40},
	    {0xb3,0x40},
	    {0xb6,0xe0},
	    {0xd0,0xcb},
	    {0xd3,0x48},
	    {0xf2,0x02},
	    {0xf7,0x12},
	    {0xf8,0x0a},
	    {0xfe,0x01},
	    {0x02,0x20},
	    {0x04,0x10},
	    {0x05,0x08},
	    {0x06,0x20},
	    {0x08,0x0a},
	    {0x0e,0x44},
	    {0x0f,0x32},
	    {0x10,0x41},
	    {0x11,0x37},
	    {0x12,0x22},
	    {0x13,0x19},
	    {0x14,0x44},
	    {0x15,0x44},
	    {0x19,0x50},
	    {0x1a,0xd8},
	    {0x32,0x10},
	    {0x35,0x00},
	    {0x36,0x80},
	    {0x37,0x00},
	    {0xfe,0x00},
};

/*******************************************************************************
* Function Name  : sensor_Init
* Description    : initialize the sensor
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
u8 sensor_Init(void)
{
     u32 i;
     u8 j;
     u8 u8Buf[2];
	 u8 SensorId;
     
	 #if(SYS_CLK == 120000000)
		sensor_ClockInit(24000000);
	 #elif(SYS_CLK == 48000000)
		sensor_ClockInit(12000000);
	 #endif
     u8SensorwriteID = GC0308_I2C_WRITE_ADDR;
     u8SensorreadID = GC0308_I2C_READ_ADDR;
     u8Addrbytnum = 1;
     u8Databytnum = 1;

	//=======close sensor power ========
	#if (I2C_MAP == I2C_MAP_SW2)			//select software simulate I2C signal
	bI2CBusy_Flag=1;					//set dc check unuse
	bSFBusy_Flag=1;						//set tf card check unuse
	REG32(PMAP_CFG0)  &= ~(1<<14);		//SPI0_MAP0 not mapping to io
	REG32(PMAP_CFG0)  &= ~(1<<7);		// uart not map to io 
	I2C_SCL_SDA_OUT();
	I2C_SCL_LOW();
	I2C_SDA_LOW();
	#endif

	REG32(SYS_CON) = 0x932B;			//SPEC request value
	REG32(LDO_ACON) &= ~(0xf << 4);		//close senosr ldo power

	#if	(USER_CONFIG==CONFIG_AX3251_K6000)		
	Delay_MS(250);		//rc reset need delay, IO reset not do it
	#endif

	#if (I2C_MAP == I2C_MAP_SW2)	//select software simulate I2C signal
	bI2CBusy_Flag=0;
	bSFBusy_Flag=0;
	#endif
	//======end close sensor power=======

	//====sensor ldo open======
	REG32(LDO_ACON) |= (4<<4);   //sensor 3bit 111:3.3v,110:3.2v .... 000:2.6v
	REG32(LDO_ACON) |= (1<<7);   //sensor ldo enable
	Delay_MS(50);
	//===end sensor ldo open====

     i2c_Init(GC0308_I2C_BAUD, GC0308_I2C_WRITE_ADDR,GC0308_I2C_READ_ADDR);
     CLRB(REG32(PCON0), 23);							//csi Clock Enable Bit

     //SENSOR_PIN_CONF();
     //SENSOR_POWERDN();
     SENSOR_NRESET();
     Delay_MS(10);
     SENSOR_RESET();
     Delay_MS(10);
     SENSOR_NRESET();
     //SENSOR_NORMAL();
     Delay_MS(10);

	i2c_SendStop();
     SensorId=u8sensor_ReadID();
     for(i=0; i<sizeof(GC0308InitTable)/2; i++)
     {
         for(j=0; j<(u8Addrbytnum+u8Databytnum); j++) 
         {
             u8Buf[j] = GC0308InitTable[i][j];    
         }   
         Sensor_WriteRegister(u8Buf,u8Addrbytnum,u8Databytnum);
         Delay_MS(1);
     }

  //   u8Buf[0] =0x28;
  //   u8Buf[1] =0x11; //2 div
   //  Sensor_WriteRegister(u8Buf,u8Addrbytnum,u8Databytnum);
	sensor_I2C_port_release();
	deg_Printf("SensorId=%x\n",SensorId);
       return 0;
}

/*******************************************************************************
* Function Name  : u8sensor_ReadID
* Description    : read sensor chip ID
* Input          : None
* Output         : None
* Return         : sensor chip ID
*******************************************************************************/
u8 u8sensor_ReadID(void)
{
    u8 u8GC0308Id;
    u8 u8Buf[2];  
    
    u8Buf[0] = GC0308_CHIP_ID_ADDR;
    u8GC0308Id = (u8)Sensor_ReadRegister(u8Buf,u8Addrbytnum,u8Databytnum); 
    //deg_Printf("u8GC0308Id=%x\n",u8GC0308Id);
    return  u8GC0308Id;               
}


//=====flag: 0 is rotate 0',  1 is rotate 180'  flip====
void sensor_rotate(u8 flag)
{

	i2c_Init(GC0308_I2C_BAUD, GC0308_I2C_WRITE_ADDR,GC0308_I2C_READ_ADDR);

	if(0 == flag)
	{
		u8 rot_buf[3];
		rot_buf[0] = 0xfe;		//select page 0
		rot_buf[1] = 0x00;
		Sensor_WriteRegister(rot_buf,1,1);
		rot_buf[0] = 0x14;		//0',180'
		rot_buf[1] = 0x13;
		Sensor_WriteRegister(rot_buf,1,1);
//		deg_Printf("sensor_rotate 0 \n");
	}
	else if(1 == flag)
	{

		u8 rot_buf[3];
		rot_buf[0] = 0xfe;		//select page 0
		rot_buf[1] = 0x00;
		Sensor_WriteRegister(rot_buf,1,1);
		rot_buf[0] = 0x14;		//0',180'
		rot_buf[1] = 0x10;
		Sensor_WriteRegister(rot_buf,1,1);
//		deg_Printf("sensor_rotate 180 \n");
	}

	sensor_I2C_port_release();
}


#endif
